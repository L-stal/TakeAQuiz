@page "/countdownclock"

<MudText Typo="Typo.h6">Time remaining:</MudText>
<MudText Typo="Typo.body1" Style="margin-bottom: 1rem;">@(timeRemaining)s</MudText>

@code {
    [Parameter]
    public int InitialTimeLimit { get; set; }

    [Parameter]
    public int QuestionIndex { get; set; }

    private int timeRemaining;
    private bool isRunning = false;
    private CancellationTokenSource cancellationToken;

    protected override void OnInitialized()
    {
        ResetCountdown();
        StartCountdown();
    }

    private void StartCountdown()
    {
        isRunning = true;
        cancellationToken = new CancellationTokenSource();

        _ = CountdownAsync(cancellationToken.Token);
    }

    private async Task CountdownAsync(CancellationToken cancellationToken = default)
    {
        await Task.Delay(500);

        while (isRunning && timeRemaining > 0)
        {
            cancellationToken.ThrowIfCancellationRequested();

            await Task.Delay(1000);
            timeRemaining--;

            StateHasChanged();
        }

        if (timeRemaining <= 0)
        {
            ResetCountdown();
        }
    }

    private void ResetCountdown()
    {
        timeRemaining = InitialTimeLimit;
        isRunning = false;
    }

    protected override void OnParametersSet()
    {
        if (QuestionIndex > 0)
        {
            cancellationToken?.Cancel();

            ResetCountdown();
            StartCountdown();
        }
    }
}